---
- name: Environment Variables file
  become: yes
  template:
    src: defaults_trytond.j2
    dest: "/etc/default/trytond"
    mode: 0640
  vars:
    OTRS_SALT: "{{ otrs_salt }}"
    OTRS_RPC_url: "{{ otrs_rpc_url }}"
    OTRS_RPC_user: "{{ otrs_rpc_user }}"
    OTRS_RPC_passw: "{{ otrs_rpc_passw }}"
    TRYTON_DATABASE: "{{ tryton_db_name }}"
    TRYTON_CONFIG: "/etc/trytond/eticom.conf"

- name: Copy sudoers configuration for Tryton  administrators
  become: yes
  template:
    src: sudoers.j2
    dest: "/etc/sudoers.d/90-tryton-admins"
    mode: 0440

- name: Create Systemd service
  become: yes
  template:
    src: trytond.service.j2
    dest: "/etc/systemd/system/trytond@.service"
    mode: 0640
  vars:
    virtualenv_path: "{{ venv_path }}"
    eticom_path: "{{ tryton_path }}"

- name: Create Cron Systemd service
  become: yes
  template:
    src: trytond-cron.service.j2
    dest: "/etc/systemd/system/trytond-cron.service"
    mode: 0640
  vars:
    virtualenv_path: "{{ venv_path }}"
    eticom_path: "{{ tryton_path }}"

- name: Create Celery-Tryton Systemd service
  become: yes
  template:
    src: trytond-celery.service.j2
    dest: "/etc/systemd/system/trytond-celery.service"
    mode: 0640
  vars:
    virtualenv_path: "{{ venv_path }}"
    eticom_path: "{{ tryton_path }}"

- name: Create Flower Systemd service
  become: yes
  template:
    src: trytond-flower.service.j2
    dest: "/etc/systemd/system/trytond-flower.service"
    mode: 0640
  vars:
    virtualenv_path: "{{ venv_path }}"
    eticom_path: "{{ tryton_path }}"

- name: Enable Systemd service
  become: yes
  systemd:
    name: "{{ item }}.service"
    enabled: yes
    state: restarted
    daemon_reload: yes
  with_items:
    - "trytond-celery"
    - "trytond-flower"
    - "trytond-cron"
    - "trytond@eticom1"
    - "trytond@eticom2"
    - "trytond@eticom3"
    - "trytond@eticom4"
